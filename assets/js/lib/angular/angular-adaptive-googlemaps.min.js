/*!
 * angular-adaptive-googlemaps v0.3.0
 * The MIT License
 * Copyright (c) 2013 Jan Antala
 */
!function(){"use strict";var a=angular.module("adaptive.googlemaps",[]);a.controller("GoogleMapsCtrl",["$scope","$element","$log","$window",function(a,b,c,d){var e="//maps.googleapis.com/maps/api/staticmap?",f=this,g=d.google,h=function(a,b,c){var d=new g.maps.Geocoder;d.geocode({address:a},function(a,d){d===g.maps.GeocoderStatus.OK?b(a[0].geometry.location):c("Geocode was not successful for the following reason: "+d)})};a.markersArray=[];var i=function(b){h(b,function(c){var d=new g.maps.Marker({position:c,title:b,map:a.map,draggable:!1});a.markersArray.push(d)})},j=function(){for(var b=0;b<a.markersArray.length;b++)a.markersArray[b].setMap(null);a.markersArray=[]},k=function(a,b){switch(a){case"satellite":return b?"k":g.maps.MapTypeId.SATELLITE;case"terrain":return b?"p":g.maps.MapTypeId.TERRAIN;case"hybrid":return b?"h":g.maps.MapTypeId.HYBRID;default:return b?"m":g.maps.MapTypeId.ROADMAP}};this.buildStaticMap=function(){var b,c={sensor:a.options.sensor,size:a.options.size,maptype:a.options.maptype,center:a.options.center,zoom:a.options.zoom,markers:a.options.markers},d=c.markers;d&&(angular.isArray(d)||(d=[d]),b=d);var f=c,g=Object.keys(f).map(function(a){return"markers"===a&&b?Object.keys(b).map(function(a){return"markers="+encodeURIComponent(b[a])}).join("&"):encodeURIComponent(a)+"="+encodeURIComponent(f[a])});!function(b){d&&d.length?d[0]:"";b.redirect&&(a.MAP_HREF="http://maps.apple.com/?&q="+a.options.center+"&z="+a.options.zoom+"&t="+k(a.options.maptype,!0))}(a.MAP_EVENTS),a.imgsrc=e+g.reduce(function(a,b){return a?void 0!==b?a+"&"+b:a:b},""),a.updateStyle()},this.buildDynamicMap=function(){if(!g)return c.error("The `googlemaps` script is required.");var d={maptype:a.options.maptype,center:a.options.center,zoom:a.options.zoom,markers:a.options.markers},e={center:new g.maps.LatLng(0,0),zoom:Number(d.zoom)||6,mapTypeId:k(d.maptype,!1)};a.map=new g.maps.Map(b[0],e),a.mapLoaded=!0,a.style["background-image"]="none",a.$apply(),h(d.center,function(b){a.map.setCenter(b);for(var c=0;d.markers&&c<d.markers.length;c++)i(d.markers[c])},function(a){c.error(a)}),g.maps.event.addListener(a.map,"zoom_changed",function(){a.options.zoom=a.map.getZoom()}),g.maps.event.addListener(a.map,"maptypeid_changed",function(){a.options.maptype=a.map.getMapTypeId()}),g.maps.event.addListener(a.map,"center_changed",function(){var b=a.map.getCenter();a.options.center=b.mb+","+b.nb})},a.updateStyle=function(){a.style={display:"block",cursor:"pointer","background-image":"url('"+(a.imgsrc||e+"sensor="+(a.options.sensor||"false")+"&size="+a.options.size)+"')","background-repeat":"no-repeat","-webkit-background-size":"cover","-moz-background-size":"cover","-o-background-size":"cover","-ms-background-size":"cover","background-size":"cover","background-position":"center center"}},a.updateStyle(),a.buildMap=function(b){if(a.mapLoaded){if("center"===b)h(a.options.center,function(b){a.map.panTo(b)},function(a){c.error(a)});else if("zoom"===b)a.map.setZoom(a.options.zoom);else if("maptype"===b)a.map.setMapTypeId(k(a.maptype));else if("markers"===b){j();for(var d=0;a.options.markers&&d<a.options.markers.length;d++)i(a.options.markers[d])}}else f.buildStaticMap()};var l=[];this.startWatching=function(){l.push(a.$watch("options.zoom",function(){a.buildMap("zoom")})),l.push(a.$watch("options.center",function(){a.buildMap("center")})),l.push(a.$watch("options.sensor",function(){a.buildMap("sensor")})),l.push(a.$watch("options.markers",function(){a.buildMap("markers")})),l.push(a.$watch("options.size",function(){a.buildMap("size")})),l.push(a.$watch("options.maptype",function(){a.buildMap("maptype")}))},this.stopWatching=function(){l.forEach(function(a){a()})}}]),a.directive("googlemaps",[function(){return{template:'<a ng-style="style" ng-href="{{MAP_HREF}}" target="_blank"></a>',replace:!0,restrict:"E",controller:"GoogleMapsCtrl",scope:{options:"="},link:function(a,b,c,d){var e=b;if(a.MAP_EVENTS=angular.extend({},a.options.mapevents),void 0===a.options.sensor)throw new Error("The `sensor` attribute is required.");if(!a.options.size)throw new Error("The `size` attribute is required.");if(!a.options.center)throw new Error("The `center` attribute is required.");var f=a.options.size.split("x");if(2!==f.length)throw new Error("Size must be specified as `wxh`.");d.buildStaticMap(),a.mapLoaded=!1,a.options.listen&&d.startWatching(),b.bind("click",function(b){a.MAP_EVENTS.loadmap&&!a.mapLoaded?(b.preventDefault(),e.removeAttr("href"),d.buildDynamicMap()):a.MAP_EVENTS.redirect||a.mapLoaded?!a.MAP_EVENTS.loadmap&&a.mapLoaded&&b.preventDefault():b.preventDefault()})}}}])}();